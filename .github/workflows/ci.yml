name: CI
on:
  push:
    branches: [master, loomi-os-phase1]
  pull_request:
    branches: [master]

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.12" }
      - run: pip install pre-commit
      - run: pre-commit run --all-files

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.12" }
      - run: pip install ruff==0.9.0
      - run: ruff check . && ruff format --check .

  type-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.12" }
      - run: pip install mypy types-requests pydantic-settings
      # Flat structure -- no app/ subdir; type-check main entry and routers
      - run: mypy main.py routers/ --ignore-missing-imports --no-strict-optional

  test:
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: sqlite:///./test.db
      LOOMI_API_KEY: test-key  # pragma: allowlist secret
      ANTHROPIC_API_KEY: sk-ant-test  # pragma: allowlist secret
      OPENAI_API_KEY: sk-test  # pragma: allowlist secret
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.12" }
      - name: Install loomi-auth from private packages repo
        run: |
          pip install "git+https://${{ secrets.LOOMI_GITHUB_PAT }}@github.com/Mister-ams/packages.git#subdirectory=loomi-auth-py"
      - name: Configure git auth for private packages
        env:
          LOOMI_GITHUB_PAT: ${{ secrets.LOOMI_GITHUB_PAT }}
        run: |
          echo "machine github.com login $LOOMI_GITHUB_PAT password x-oauth-basic" > ~/.netrc
          chmod 600 ~/.netrc
      - run: pip install -e ".[dev]"
      - run: pytest -m "not integration" --cov=. --cov-fail-under=60

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.12" }
      - run: pip install pip-audit
      - run: pip-audit || true

  schema-drift:
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: sqlite:///./test.db
      LOOMI_API_KEY: test-key  # pragma: allowlist secret
      ANTHROPIC_API_KEY: sk-ant-test  # pragma: allowlist secret
      OPENAI_API_KEY: sk-test  # pragma: allowlist secret
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.12" }
      - name: Install loomi-auth from private packages repo
        run: |
          pip install "git+https://${{ secrets.LOOMI_GITHUB_PAT }}@github.com/Mister-ams/packages.git#subdirectory=loomi-auth-py"
      - name: Configure git auth for private packages
        env:
          LOOMI_GITHUB_PAT: ${{ secrets.LOOMI_GITHUB_PAT }}
        run: |
          echo "machine github.com login $LOOMI_GITHUB_PAT password x-oauth-basic" > ~/.netrc
          chmod 600 ~/.netrc
      - run: pip install -e ".[dev]"
      # Flat structure -- import from main, not app.main
      - run: python -c "from main import app; import json; open('openapi.gen.json','w').write(json.dumps(app.openapi(), indent=2))"
      - run: |
          if [ -f openapi.json ]; then
            diff openapi.json openapi.gen.json || (echo "OpenAPI spec drift -- commit updated openapi.json" && exit 1)
          else
            echo "No committed openapi.json -- skipping diff (first run)"
          fi

  build:
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: sqlite:///./test.db
      LOOMI_API_KEY: test-key  # pragma: allowlist secret
      ANTHROPIC_API_KEY: sk-ant-test  # pragma: allowlist secret
      OPENAI_API_KEY: sk-test  # pragma: allowlist secret
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.12" }
      - name: Install loomi-auth from private packages repo
        run: |
          pip install "git+https://${{ secrets.LOOMI_GITHUB_PAT }}@github.com/Mister-ams/packages.git#subdirectory=loomi-auth-py"
      - name: Configure git auth for private packages
        env:
          LOOMI_GITHUB_PAT: ${{ secrets.LOOMI_GITHUB_PAT }}
        run: |
          echo "machine github.com login $LOOMI_GITHUB_PAT password x-oauth-basic" > ~/.netrc
          chmod 600 ~/.netrc
      - run: pip install -e ".[dev]"
      # Flat structure -- import from main, not app.main
      - run: python -c "from main import app; print('import OK')"

  deploy:
    needs: [lint, type-check, test, security, build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: railway up --service ${{ vars.RAILWAY_SERVICE_NAME }} --detach

      - name: Post-deploy smoke test
        run: |
          sleep 15
          for i in $(seq 1 6); do
            STATUS=$(curl -sf -o /dev/null -w "%{http_code}" \
              -H "X-API-Key: ${{ secrets.LOOMI_API_KEY }}" \
              "${{ vars.SERVICE_URL }}/health/deep")
            [ "$STATUS" = "200" ] && echo "Smoke test passed" && exit 0
            echo "Attempt $i: status $STATUS -- retrying in 10s"
            sleep 10
          done
          echo "Smoke test failed"
          exit 1

  doc-automation:
    needs: [deploy]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    permissions:
      contents: write
    env:
      DATABASE_URL: sqlite:///./test.db
      LOOMI_API_KEY: test-key  # pragma: allowlist secret
      ANTHROPIC_API_KEY: sk-ant-test  # pragma: allowlist secret
      OPENAI_API_KEY: sk-test  # pragma: allowlist secret
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-python@v5
        with: { python-version: "3.12" }

      - name: Install loomi-auth from private packages repo
        run: |
          pip install "git+https://${{ secrets.LOOMI_GITHUB_PAT }}@github.com/Mister-ams/packages.git#subdirectory=loomi-auth-py"

      - name: Configure git auth for private packages
        env:
          LOOMI_GITHUB_PAT: ${{ secrets.LOOMI_GITHUB_PAT }}
        run: |
          echo "machine github.com login $LOOMI_GITHUB_PAT password x-oauth-basic" > ~/.netrc
          chmod 600 ~/.netrc

      - run: pip install -e ".[dev]"

      - name: Generate openapi.json
        run: |
          python -c "
          from main import app
          import json
          spec = app.openapi()
          with open('openapi.json', 'w') as f:
              json.dump(spec, f, indent=2)
          "

      - name: Check CLAUDE.md size
        run: python3 scripts/lint_claude_md.py

      - name: Generate CHANGELOG.md with git-cliff
        uses: orhun/git-cliff-action@v3
        with:
          config: cliff.toml
          args: --verbose
        env:
          OUTPUT: CHANGELOG.md

      - name: Commit generated files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add openapi.json CHANGELOG.md
          git diff --staged --quiet || git commit -m "docs: update openapi.json and CHANGELOG [skip ci]"
          git push
